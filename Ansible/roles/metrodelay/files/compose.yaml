networks:
  metrodelay:
    driver: bridge

services:
  remote-resources:
    image: fra.vultrcr.com/metrodelay/remote-resources:0.0.2
    container_name: remote-resources
    hostname: remote-resources
    networks:
      - metrodelay
    command: ["-i", "pt2m", "-d", "pt2m"]
  metrodelay-storage:
    image: fra.vultrcr.com/metrodelay/metrodelay-storage:0.0.2
    container_name: metrodelay-storage
    hostname: metrodelay-storage
    ports:
      - "8081:8080"
    networks:
      - metrodelay
    command: ["-h", "metrodelay-storage"]
  metrodelay-rest:
    image: fra.vultrcr.com/metrodelay/metrodelay-rest:0.0.2
    container_name: metrodelay-rest
    hostname: metrodelay-rest
    ports:
      - "8080:8080"
    networks:
      - metrodelay
  alloy:
    container_name: alloy
    image: grafana/alloy:v1.12.2
    hostname: alloy
    user: root
    cap_add:
      - SYS_PTRACE
      - DAC_READ_SEARCH
    pid: host
    network_mode: host
    volumes:
      - type: bind
        source: ./config.alloy
        target: /etc/alloy/config.alloy
      - type: bind
        source: ./endpoints.json
        target: /etc/alloy/endpoints.json
      - type: bind
        source: /var/log
        target: /var/log
      # WARNING: Mounting the Docker socket gives this container full control
      # over the Docker daemon on the host. Consider using the Docker API
      # over TLS with authentication instead of mounting /var/run/docker.sock directly.
      - type: bind
        source: /var/lib/docker/containers
        target: /var/lib/docker/containers
      - type: bind
        source: /var/run/docker.sock
        target: /var/run/docker.sock
      - type: bind
        source: /
        target: /host
        read_only: true
        bind:
          propagation: rslave
    command: [
      "run",
      "--server.http.listen-addr=0.0.0.0:12345",
      "--stability.level=public-preview",
      "/etc/alloy/config.alloy",
    ]